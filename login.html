<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://apis.google.com 'unsafe-inline' 'unsafe-eval';">
    
    <title>Acceso | Mercado Raíz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="auth-body"> 
    <div id="toast-container"></div>

    <div class="auth-wrapper">
        <div class="card auth-card">
            <div class="auth-header">
                <img src="assets/images/logo.png" alt="Mercado Raíz" class="auth-logo">
                <h2 id="authTitle">Iniciar Sesión</h2>
                <p class="auth-subtitle">Conectando productores de Cayambe</p>
            </div>
            
            <form id="loginForm">
                <div id="registroExtra" class="hidden">
                    <div class="form-group">
                        <label for="reg_nombre"><i class="fas fa-user"></i> Nombre Completo</label>
                        <input type="text" id="reg_nombre" class="admin-input" placeholder="Ej. Juan Pérez" autocomplete="name">
                    </div>
                </div>

                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Correo Electrónico</label>
                    <input type="email" id="email" class="admin-input" required placeholder="tu@correo.com" autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Contraseña</label>
                    <input type="password" id="password" class="admin-input" required minlength="6" placeholder="Mínimo 6 caracteres" autocomplete="current-password">
                </div>

                <button type="submit" id="btnSubmit" class="btn-primary-admin">
                    Ingresar
                </button>
            </form>

            <div class="auth-footer">
                <p class="auth-switch">
                    <span id="toggleText">¿No tienes cuenta?</span> 
                    <a href="javascript:void(0)" onclick="toggleAuth()" id="toggleLink">Regístrate aquí</a>
                </p>
                <div class="auth-back">
                    <a href="index.html"><i class="fas fa-arrow-left"></i> Volver a la tienda</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBqakqg919pu0GjMkaJhntman0n4Q1jnw",
        authDomain: "mercado-raiz.firebaseapp.com",
        databaseURL: "https://mercado-raiz-default-rtdb.firebaseio.com",
        projectId: "mercado-raiz",
        storageBucket: "mercado-raiz.firebasestorage.app",
        messagingSenderId: "886584284411",
        appId: "1:886584284411:web:NDI3ZqYWUtYWNhNS00NzEwLWIxMDktWjNmViYzk4Njly"
      };

      if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
      }
      
      // Disponibilidad global inmediata
      window.db = firebase.database(); 
      window.auth = firebase.auth();
      window.storage = firebase.storage();
    </script>

    <script src="js/auth.js"></script>
    
    <script>
        // Lógica de Toast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        window.alert = function(msg) {
            const esExito = msg.toLowerCase().includes("exitoso") || msg.toLowerCase().includes("bienvenido");
            showToast(msg, esExito ? 'success' : 'error');
        };

        // Captura del Formulario con prevención de bloqueo
        let isLogin = true;
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const nombre = document.getElementById('reg_nombre')?.value.trim();

            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerText = "Procesando...";

            try {
                if (isLogin) {
                    await iniciarSesion(email, password);
                } else {
                    await registrarUsuario(nombre, email, password);
                }
            } catch (err) {
                console.error("Submit Error:", err);
            } finally {
                btn.disabled = false;
                btn.innerText = isLogin ? "Ingresar" : "Registrarse";
            }
        });

        function toggleAuth() {
            isLogin = !isLogin;
            document.getElementById('authTitle').innerText = isLogin ? "Iniciar Sesión" : "Crear Cuenta";
            document.getElementById('btnSubmit').innerText = isLogin ? "Ingresar" : "Registrarse";
            document.getElementById('toggleText').innerText = isLogin ? "¿No tienes cuenta?" : "¿Ya tienes cuenta?";
            document.getElementById('toggleLink').innerText = isLogin ? "Regístrate aquí" : "Inicia sesión";
            document.getElementById('registroExtra').classList.toggle('hidden', isLogin);
            if(document.getElementById('reg_nombre')) document.getElementById('reg_nombre').required = !isLogin;
        }
    </script>

    <div id="notification-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>
</body>
</html>